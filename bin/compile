#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir>
set -e

mktmpdir() {
  dir=$(mktemp -t fakesu-$1-XXXX)
  rm -rf $dir
  mkdir -p $dir
  echo $dir
}

function indent() {
  c='s/^/       /'
  case $(uname) in
    Darwin) sed -l "$c";;
    *)      sed -u "$c";;
  esac
}

BUILDPACK_DIR=`cd $(dirname $0); cd ..; pwd`
BUILD_DIR=$1
CACHE_DIR=$2

GRAPHVIZ_BUILD="$(mktmpdir graphviz)"

mkdir -p $CACHE_DIR/graphviz

GRAPHVIZ_VERSION="2.28.0"

if [ -f $CACHE_DIR/graphviz/version ]; then
  CACHED_VERSION=`cat $CACHE_DIR/graphviz/version`
else
  CACHED_VERSION=''
fi

export PATH=/sbin:/usr/sbin:$PATH:

if [ $CACHED_VERSION == $GRAPHVIZ_VERSION ]; then
  echo "-----> Detected cached version" $CACHED_VERSION "is valid. Skipping building."
else
  echo "-----> Fetching graphviz"
  cd $WGET_BUILD
  curl -O http://www.graphviz.org/pub/graphviz/stable/SOURCES/graphviz-2.28.0.tar.gz >/dev/null 2>&1
  tar zxvf graphviz-2.28.0.tar.gz >/dev/null 2>&1
  cd graphviz-2.28.0
  echo "-----> Configuring graphviz"
  ./configure --prefix=$CACHE_DIR/graphviz >/dev/null 2>&1
  echo "-----> Compiling graphviz"
  make -j5 >/dev/null 2>&1
  echo "-----> Installing graphviz"
  make install >/dev/null 2>&1
  echo "grapvhiz installed" | indent
  echo $GRAPHVIZ_VERSION > $CACHE_DIR/graphviz/version
fi

exit 0
